(function(t,e){typeof exports==="object"&&typeof module!=="undefined"?e(exports):typeof define==="function"&&define.amd?define(["exports"],e):(t=t||self,e(t.CanvasFreeDrawing={}))})(this,(function(t){"use strict";var e=typeof globalThis!=="undefined"?globalThis:typeof window!=="undefined"?window:typeof global!=="undefined"?global:typeof self!=="undefined"?self:{};function o(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t["default"]:t}function s(t,e){return e={exports:{}},t(e,e.exports),e.exports}var i=s((function(t,o){var s=e&&e.__spreadArrays||function(){for(var t=0,e=0,o=arguments.length;e<o;e++)t+=arguments[e].length;for(var s=Array(t),i=0,e=0;e<o;e++)for(var n=arguments[e],r=0,a=n.length;r<a;r++,i++)s[i]=n[r];return s};Object.defineProperty(o,"__esModule",{value:true});o.AllowedEvents=void 0;var i;(function(t){t["redraw"]="redraw";t["fill"]="fill";t["mouseup"]="mouseup";t["mousedown"]="mousedown";t["mouseenter"]="mouseenter";t["mouseleave"]="mouseleave"})(i=o.AllowedEvents||(o.AllowedEvents={}));var n=function(){function t(t){var e=t.elementId,o=t.width,s=t.height,i=t.backgroundColor,n=i===void 0?[255,255,255]:i,r=t.lineWidth,a=r===void 0?5:r,h=t.strokeColor,l=h===void 0?[0,0,0]:h,u=t.disabled,d=t.showWarnings,c=d===void 0?false:d,v=t.maxSnapshots,p=v===void 0?10:v;this.requiredParam(t,"elementId");this.requiredParam(t,"width");this.requiredParam(t,"height");this.elementId=e;this.canvasNode=document.getElementById(this.elementId);if(this.canvasNode instanceof HTMLCanvasElement){this.canvas=this.canvasNode}else if(this.canvasNode instanceof HTMLElement){var f=document.createElement("canvas");this.canvasNode.appendChild(f);this.canvas=f}else{throw new Error("No element found with following id: "+this.elementId)}this.context=this.canvas.getContext("2d");this.width=o;this.height=s;this.maxSnapshots=p;this.snapshots=[];this.undos=[];this.positions=[];this.leftCanvasDrawing=false;this.isDrawing=false;this.isDrawingModeEnabled=true;this.imageRestored=false;this.lineWidth=a;this.strokeColor=this.toValidColor(l);this.bucketToolColor=this.toValidColor(l);this.bucketToolTolerance=0;this.isBucketToolEnabled=false;this.listenersList=["mouseDown","mouseMove","mouseLeave","mouseUp","touchStart","touchMove","touchEnd"];this.allowedEvents=this.getAllowedEvents();this.redrawCounter=0;this.dispatchEventsOnceEvery=0;this.events={redrawEvent:new Event("cfd_redraw"),fillEvent:new Event("cfd_fill"),mouseUpEvent:new Event("cfd_mouseup"),mouseDownEvent:new Event("cfd_mousedown"),mouseEnterEvent:new Event("cfd_mouseenter"),mouseLeaveEvent:new Event("cfd_mouseleave"),touchStartEvent:new Event("cfd_touchstart"),touchEndEvent:new Event("cfd_touchend")};this.bindings={mouseDown:this.mouseDown.bind(this),mouseMove:this.mouseMove.bind(this),mouseLeave:this.mouseLeave.bind(this),mouseUp:this.mouseUp.bind(this),mouseUpDocument:this.mouseUpDocument.bind(this),touchStart:this.touchStart.bind(this),touchMove:this.touchMove.bind(this),touchEnd:this.touchEnd.bind(this)};this.touchIdentifier=undefined;this.previousX=undefined;this.previousY=undefined;this.showWarnings=c;this.isNodeColorEqualCache={};this.setDimensions();this.setBackground(n);this.storeSnapshot();if(!u)this.enableDrawingMode()}t.prototype.requiredParam=function(t,e){if(!t||!t[e]){throw new Error(e+" is required")}};t.prototype.logWarning=function(){var t=[];for(var e=0;e<arguments.length;e++){t[e]=arguments[e]}if(this.showWarnings)console.warn.apply(console,t)};t.prototype.addListeners=function(){var t=this;this.listenersList.forEach((function(e){t.canvas.addEventListener(e.toLowerCase(),t.bindings[e])}));document.addEventListener("mouseup",this.bindings.mouseUpDocument)};t.prototype.removeListeners=function(){var t=this;this.listenersList.forEach((function(e){t.canvas.removeEventListener(e.toLowerCase(),t.bindings[e])}));document.removeEventListener("mouseup",this.bindings.mouseUpDocument)};t.prototype.getAllowedEvents=function(){var t=[];for(var e in i){t.push(e)}return t};t.prototype.enableDrawingMode=function(){this.isDrawingModeEnabled=true;this.addListeners();this.toggleCursor();return this.isDrawingModeEnabled};t.prototype.disableDrawingMode=function(){this.isDrawingModeEnabled=false;this.removeListeners();this.toggleCursor();return this.isDrawingModeEnabled};t.prototype.mouseDown=function(t){if(t.button!==0)return;this.drawPoint(t.offsetX,t.offsetY)};t.prototype.mouseMove=function(t){this.drawLine(t.offsetX,t.offsetY,t)};t.prototype.touchStart=function(t){if(t.changedTouches.length>0){var e=t.changedTouches[0],o=e.pageX,s=e.pageY,i=e.identifier;var n=this.canvas.getBoundingClientRect();var r=o-n.left;var a=s-n.top;this.touchIdentifier=i;this.drawPoint(r,a)}};t.prototype.touchMove=function(t){if(t.changedTouches.length>0){var e=t.changedTouches[0],o=e.pageX,s=e.pageY,i=e.identifier;var n=this.canvas.getBoundingClientRect();var r=o-n.left;var a=s-n.top;if(i!=this.touchIdentifier)return;this.previousX=r;this.previousY=a;this.drawLine(r,a,t)}};t.prototype.touchEnd=function(){this.handleEndDrawing();this.canvas.dispatchEvent(this.events.touchEndEvent)};t.prototype.mouseUp=function(){this.handleEndDrawing();this.canvas.dispatchEvent(this.events.mouseUpEvent)};t.prototype.mouseUpDocument=function(){this.leftCanvasDrawing=false};t.prototype.mouseLeave=function(){if(this.isDrawing)this.leftCanvasDrawing=true;this.isDrawing=false;this.canvas.dispatchEvent(this.events.mouseLeaveEvent)};t.prototype.mouseEnter=function(){this.canvas.dispatchEvent(this.events.mouseEnterEvent)};t.prototype.handleEndDrawing=function(){this.isDrawing=false;this.storeSnapshot()};t.prototype.drawPoint=function(t,e){if(this.isBucketToolEnabled){this.fill(t,e,this.bucketToolColor,{tolerance:this.bucketToolTolerance})}else{this.isDrawing=true;this.storeDrawing(t,e,false);this.canvas.dispatchEvent(this.events.mouseDownEvent);this.handleDrawing()}};t.prototype.drawLine=function(t,e,o){if(this.leftCanvasDrawing){this.leftCanvasDrawing=false;if(o instanceof MouseEvent){this.mouseDown(o)}else if(o instanceof TouchEvent){this.touchEnd()}}if(this.isDrawing){this.storeDrawing(t,e,true);this.handleDrawing(this.dispatchEventsOnceEvery)}};t.prototype.handleDrawing=function(t){var e=this;this.context.lineJoin="round";var o=[s(this.positions).pop()];o.forEach((function(t){if(t&&t[0]&&t[0].strokeColor){e.context.strokeStyle=e.rgbaFromArray(t[0].strokeColor);e.context.lineWidth=t[0].lineWidth;e.draw(t)}}));if(!t){this.canvas.dispatchEvent(this.events.redrawEvent)}else if(this.redrawCounter%t===0){this.canvas.dispatchEvent(this.events.redrawEvent)}this.undos=[];this.redrawCounter+=1};t.prototype.draw=function(t){var e=this;t.forEach((function(o,s){var i=o.x,n=o.y,r=o.moving;e.context.beginPath();if(r&&s){e.context.moveTo(t[s-1]["x"],t[s-1]["y"])}else{e.context.moveTo(i-1,n)}e.context.lineTo(i,n);e.context.closePath();e.context.stroke()}))};t.prototype.fill=function(t,e,o,s){var i=s.tolerance;o=this.toValidColor(o);if(this.positions.length===0&&!this.imageRestored){this.setBackground(o,false);this.canvas.dispatchEvent(this.events.redrawEvent);this.canvas.dispatchEvent(this.events.fillEvent);return}var n=this.width*this.height;var r=this.context.getImageData(0,0,this.width,this.height);var a=r.data;var h=this.getNodeColor(t,e,a);if(this.isNodeColorEqual(h,o,i))return;var l=[];l.push([t,e]);while(l.length){if(l.length>n)break;var u=l.pop();var d=u;var c=u;while(this.isNodeColorEqual(this.getNodeColor(d[0]-1,d[1],a),h,i)){d=[d[0]-1,d[1]]}while(this.isNodeColorEqual(this.getNodeColor(c[0]+1,c[1],a),h,i)){c=[c[0]+1,c[1]]}var v=d[0];var p=c[0];for(var f=v;f<=p;f++){this.setNodeColor(f,d[1],o,a);if(this.isNodeColorEqual(this.getNodeColor(f,d[1]+1,a),h,i)){l.push([f,d[1]+1])}if(this.isNodeColorEqual(this.getNodeColor(f,d[1]-1,a),h,i)){l.push([f,d[1]-1])}}}this.context.putImageData(r,0,0);this.canvas.dispatchEvent(this.events.redrawEvent);this.canvas.dispatchEvent(this.events.fillEvent)};t.prototype.toValidColor=function(t){if(Array.isArray(t)&&t.length===4)return t;if(Array.isArray(t)&&t.length===3){var e=s(t);e.push(255);return e}else{this.logWarning("Color is not valid!\n"+"It must be an array with RGB values:  [0-255, 0-255, 0-255]");return[0,0,0,255]}};t.prototype.isNodeColorEqual=function(t,e,o){var s=""+t[0]+t[1]+t[2]+t[3];var i=""+e[0]+e[1]+e[2]+e[3];var n=s+i+o;o=o||0;if(this.isNodeColorEqualCache.hasOwnProperty(s+i+o)){return this.isNodeColorEqualCache[n]}var r=Math.abs(e[0]-t[0]);var a=Math.abs(e[1]-t[1]);var h=Math.abs(e[2]-t[2]);var l=r/255;var u=a/255;var d=h/255;var c=(l+u+d)/3*100;var v=o>=c;this.isNodeColorEqualCache[n]=v;return v};t.prototype.getNodeColor=function(t,e,o){var s=(t+e*this.width)*4;return[o[s],o[s+1],o[s+2],o[s+3]]};t.prototype.setNodeColor=function(t,e,o,s){var i=(t+e*this.width)*4;s[i]=o[0];s[i+1]=o[1];s[i+2]=o[2];s[i+3]=o[3]};t.prototype.rgbaFromArray=function(t){return"rgba("+t[0]+","+t[1]+","+t[2]+","+t[3]+")"};t.prototype.setDimensions=function(){this.canvas.height=this.height;this.canvas.width=this.width};t.prototype.toggleCursor=function(){this.canvas.style.cursor=this.isDrawingModeEnabled?"crosshair":"auto"};t.prototype.storeDrawing=function(t,e,o){if(o){var s=this.positions.length-1;this.positions[s].push({x:t,y:e,moving:o,lineWidth:this.lineWidth,strokeColor:this.strokeColor,isBucket:false})}else{this.positions.push([{x:t,y:e,isBucket:false,moving:o,lineWidth:this.lineWidth,strokeColor:this.strokeColor}])}};t.prototype.storeSnapshot=function(){var t=this.getCanvasSnapshot();this.snapshots.push(t);if(this.snapshots.length>this.maxSnapshots){this.snapshots=this.snapshots.splice(-Math.abs(this.maxSnapshots))}};t.prototype.getCanvasSnapshot=function(){return this.context.getImageData(0,0,this.width,this.height)};t.prototype.restoreCanvasSnapshot=function(t){this.context.putImageData(t,0,0)};t.prototype.on=function(t,e){var o=t.event,s=t.counter;this.requiredParam(t,"event");if(this.allowedEvents.includes(o)){if(o==="redraw"&&s&&Number.isInteger(s)){this.dispatchEventsOnceEvery=s}this.canvas.addEventListener("cfd_"+o,(function(){return e()}))}else{this.logWarning("This event is not allowed: "+o)}};t.prototype.setLineWidth=function(t){this.lineWidth=t};t.prototype.setBackground=function(t,e){if(e===void 0){e=true}var o=this.toValidColor(t);if(o){if(e)this.backgroundColor=o;this.context.fillStyle=this.rgbaFromArray(o);this.context.fillRect(0,0,this.width,this.height)}};t.prototype.setDrawingColor=function(t){this.configBucketTool({color:t});this.setStrokeColor(t)};t.prototype.setStrokeColor=function(t){this.strokeColor=this.toValidColor(t)};t.prototype.configBucketTool=function(t){var e=t.color,o=e===void 0?null:e,s=t.tolerance,i=s===void 0?null:s;if(o)this.bucketToolColor=this.toValidColor(o);if(i&&i>0){this.bucketToolTolerance=i>100?100:i}};t.prototype.toggleBucketTool=function(){return this.isBucketToolEnabled=!this.isBucketToolEnabled};t.prototype.toggleDrawingMode=function(){return this.isDrawingModeEnabled?this.disableDrawingMode():this.enableDrawingMode()};t.prototype.clear=function(){this.context.clearRect(0,0,this.width,this.height);this.positions=[];this.imageRestored=false;if(this.backgroundColor)this.setBackground(this.backgroundColor);this.handleEndDrawing()};t.prototype.save=function(){return this.canvas.toDataURL()};t.prototype.restore=function(t,e){var o=this;var s=new Image;s.src=t;s.onload=function(){o.imageRestored=true;o.context.drawImage(s,0,0);if(typeof e==="function")e()}};t.prototype.undo=function(){var t=this.snapshots[this.snapshots.length-1];var e=this.snapshots[this.snapshots.length-2];if(e){this.restoreCanvasSnapshot(e);this.snapshots.pop();this.undos.push(t);this.undos=this.undos.splice(-Math.abs(this.maxSnapshots));this.imageRestored=true}else{this.logWarning("There are no more undos left.")}};t.prototype.redo=function(){if(this.undos.length>0){var t=this.undos.pop();if(t){this.restoreCanvasSnapshot(t);this.snapshots.push(t);this.snapshots=this.snapshots.splice(-Math.abs(this.maxSnapshots))}}else{this.logWarning("There are no more redo left.")}};return t}();o.default=n}));var n=o(i);var r=i.AllowedEvents;t.AllowedEvents=r;t.default=n;Object.defineProperty(t,"__esModule",{value:true})}));